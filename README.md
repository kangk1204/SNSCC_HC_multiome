# SNSCC HC Multiome Analysis

This repository contains the R scripts used to process and analyze single-nucleus multiome (RNA + ATAC) data for the SNSCC study. The code was written to support a manuscript submission and covers sample preprocessing, QC, clustering, differential accessibility, motif analysis, trajectory inference, CNV inference, and cell–cell communication modelling.

The numbered scripts (`1_` … `10_`) are intended to be run sequentially. Each script assumes that the artefacts generated by the previous steps (RDS objects, figures, tables) are available in the relative folders referenced inside the code.

## Repository Layout

- `1_SNSCC_HC_multiome_pre_processing.R` – Create Seurat/Signac objects from 10x Genomics Cell Ranger ARC outputs, perform SoupX correction, QC, doublet removal, peak set construction, and generate initial RDS objects.
- `2_SNSCC_HC_multiome_downstream_analysis.R` – Integrate RNA + ATAC modalities, clustering, marker discovery, pathway scoring, and visualization of the full dataset.
- `3_SNSCC_HC_multiome_LinkPeaks.R` – Run Signac peak-to-gene linkage and export differential accessibility results and linked gene tables.
- `4_SNSCC_HC_multiome_Motif_analysis.R` – chromVAR-based motif enrichment and visualization for selected cell states.
- `5_SNSCC_HC_multiome_Epithelial_cell_clusters.R` – Sub-cluster epithelial cells, annotate states, and export intermediate RDS objects.
- `6_SNSCC_HC_multiome_Epithelial_cell_clusters_infercnv.R` – Prepare inferCNV inputs and run CNV inference on epithelial subsets.
- `7_SNSCC_HC_multiome_CellChat_HC_Tumor_merge.R` – Build CellChat objects for healthy vs tumour comparisons and export interaction metrics.
- `8_SNSCC_HC_multiome_CellChat_CellType_epi.R` – CellChat analyses focused on epithelial cell type re-labelling.
- `9_SNSCC_HC_multiome_CellChat_CellType_epi_endo_rename.R` – Additional CellChat runs after epithelial/endothelial re-annotation and figure export.
- `10_SNSCC_HC_multiome_Endothelial_cell_clusters.R` – Sub-cluster endothelial cells and perform downstream visualizations.

Common input/output locations expected by the scripts:

- `cellranger-arc_outputs/` – 10x Genomics ARC outputs (`filtered_feature_bc_matrix.h5`, `atac_fragments.tsv.gz`, `atac_peaks.bed`, `per_barcode_metrics.csv`, etc.).
- `RDS_files/` – Serialized objects saved and re-used between scripts (e.g. `snscc_filtered_res_08.rds`, `Epi_rename_res_045.rds`).
- `Documents/` – Tabular exports (`*.txt`, `*.csv`).
- `Figures/` – Generated figures (`*.pdf`, `*.png`).
- `cellchat/` – CellChat outputs organised per analysis (`cellchat/custom/...` subfolders).
- `infercnv/` – inferCNV intermediate files and results.

> **Important:** Several scripts still reference absolute paths from the development workstation (e.g. `/home/iphd2/Desktop/...`). Replace those with the corresponding locations on your system before running the pipeline. Keeping a central configuration snippet (e.g. using `base_dir <- "..."`) at the top of each script can help.
> **Quick check:** search for `/home/iphd2/Desktop/SNSCC_HC_multiome_2024` in the scripts and update to your own base directory.

## Prerequisites

1. **R environment**
   - R ≥ 4.2 is recommended.
   - RStudio (or VS Code with the R extension) is convenient but not required.
2. **System libraries**
   - On macOS: install Xcode command-line tools (`xcode-select --install`) and, if you use `ArchR`, the system `arrow` library (`brew install libgit2 cmake apache-arrow`).
   - On Linux: ensure `libcurl`, `openssl`, `libxml2`, and build-essential toolchains are installed.
3. **10x Genomics inputs**
   - Run Cell Ranger ARC per sample to obtain the filtered matrix and fragment files.
   - Harmonise barcode prefixes if you merge multiple samples.

## R Package Installation

Open an R session in the project root and run the following. The snippets install CRAN, Bioconductor, and GitHub dependencies that appear across the scripts.

```r
# 1. Core dependency managers
install.packages(c("BiocManager", "remotes"))

# 2. CRAN packages
cran_pkgs <- c(
  "Seurat", "Signac", "SoupX", "harmony", "dittoSeq", "ggplot2",
  "RColorBrewer", "viridis", "pheatmap", "dplyr", "tidyr",
  "magrittr", "stringr", "ggpubr", "ggsignif", "ggplotify",
  "ggthemes", "gridExtra", "ggbeeswarm", "Matrix", "Polychrome"
)
install.packages(setdiff(cran_pkgs, installed.packages()[, "Package"]))

# 3. Bioconductor packages
bioc_pkgs <- c(
  "EnsDb.Hsapiens.v86", "BSgenome.Hsapiens.UCSC.hg38", "chromVAR",
  "JASPAR2020", "TFBSTools", "motifmatchr", "SingleCellExperiment",
  "scDblFinder", "ComplexHeatmap", "GSVA", "limma", "infercnv",
  "slingshot", "tradeSeq", "monocle"
)
BiocManager::install(setdiff(bioc_pkgs, installed.packages()[, "Package"]))

# 4. Additional packages (CRAN or Bioconductor, depending on availability)
BiocManager::install(c("progeny"))

# 5. GitHub packages
remotes::install_github("samuel-marsh/scCustomize")
remotes::install_github("satijalab/seurat-wrappers")
remotes::install_github("GreenleafLab/ArchR")
remotes::install_github("sqjin/CellChat")
remotes::install_github("ncborcherding/scProportionTest")
```

Review the console output; some packages (e.g. `ArchR`, `infercnv`) compile C/C++ code and may require extra system dependencies. Re-run the commands if an installation fails due to missing libraries.

## Running the Analysis

1. **Organise the data**
   - Place each sample’s Cell Ranger ARC output inside `cellranger-arc_outputs/`.
   - Create the output folders used by the scripts if they do not exist (`RDS_files`, `Figures`, `Documents`, `cellchat/custom/...`, `infercnv`, etc.).
   - (Optional) Create symbolic links if the raw data are stored elsewhere to avoid copying large files.

2. **Configure file paths**
   - Open each script and adjust any absolute paths or repeated placeholder paths so that they point to your data.
   - Consider defining a reusable vector with sample metadata (sample IDs, directories) to avoid manual duplication.

3. **Execute the numbered scripts**
   - Run each script with `Rscript <script_name>.R` from the project root, for example:
     ```bash
     Rscript 1_SNSCC_HC_multiome_pre_processing.R
     Rscript 2_SNSCC_HC_multiome_downstream_analysis.R
     ...
     Rscript 10_SNSCC_HC_multiome_Endothelial_cell_clusters.R
     ```
   - Inspect the console output for warnings or errors before moving to the next step.
   - Intermediate `.rds`, `.txt`, and `.pdf` files will accumulate in the folders referenced within each script.

4. **Checkpointing**
   - After each major step, verify that the expected RDS files and figures are created (especially `snscc_filtered_res_08.rds`, `Epi_rename_res_045.rds`, and CellChat exports).
   - Commit those artefacts you wish to share publicly; otherwise, add them to `.gitignore` (see below).

## Contact & Citation

- Upstream issues: https://github.com/kangk1204/SNSCC_HC_multiome/issues
